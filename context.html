<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Context</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link href="css/globe_master.css" rel="stylesheet"> 
  <link rel="shortcut icon" href="assets/img/nglogo.png" type="image/x-icon">
  <link href="css/perfect-scrollbar.css" rel="stylesheet">    
  <link href="https://fonts.googleapis.com/css?family=Buenard|Lustria|Vollkorn&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
  <style>
   a{
     color:silver;
   }
   h3{
     color:rgb(255, 255, 255);
   }
   /* SVG styling */
   html {
    -moz-osx-font-smoothing: grayscale;
    -webkit-font-smoothing: antialiased;
   
    font-weight: 400;
    }

    @-moz-document url-prefix() {
        body {
            font-weight: lighter !important;
        }
    }
  </style>
</head>

<body>
    <div class="navBar">
        <a href="index.html" class="back">Back</a>
        <a href="index.html" class="home">Global Refugee Atlas</a>
      </div>
  <div class="row">
    <div id="infoPanel" class="col-md-3">
        <div class="topBar"><a href="index.html"><img id="ng" src="assets/img/ng.png"></a></div>
        <h1 style="font-size:42px;">CONTEXT</h1> 
        <div id="text">
              <p style="font-size:18px;font-variant: small-caps;text-align: left;">Factors that influence international crises and cause forced migrations</p>
              <div class="dropdown" style="padding-bottom:20px;">
                <button class="dropbtn">Select Map</button>
                <div class="dropdown-content">                  
                  <a href="#"onclick="setConflict()">Violence</a>
                  <a href="#"onclick="setHDI()">HDI</a>
                  <a href="#"onclick="setPoverty()">Poverty</a>
                  <a href="#"onclick="setEnvironment()">Environment</a>
                </div>
              </div>
              <div class="legend_container" id="con_legend">
                  <h2>Conflict Types</h2> 
                  <div class="legend" style="background:linear-gradient(to right, #993333, #993333 33%, #ffff00 33%, #ffff00 66%, #e68a00 66%);"></div>         
                  <p class="legend_label" style="margin-left:0px;">Battle</p>
                  <p class="legend_label" style="margin-left:47px;">Remote</p>
                  <p class="legend_label" style="margin-left:38px;">Civilian</p>
                  <h2 style="font-size:24px; margin-top:30px;">Violence</h2>
                  <p style="padding-top: 10px">War and ethnic, tribal and religious violence are leading causes of refugees fleeing their countries. This map shows major violent events that took place in the past five years. Data is retrieved from the Armed Conflict Location & Event Data Project (ACLED). ACLED is a disaggregated conflict collection, analysis and crisis mapping project that collects the dates, actors, types of violence, locations, and fatalities of all reported political violence and protest events.(<a href="https://www.acleddata.com/" target="_blank">link</a>)</p>
                    <p style="margin-top:10px;"><b>BATTLES </b>are	 violent clashes	between	at least two armed groups. <b>REMOTE</b> violence refers to events where an explosion, bomb or other explosive device was used to engage in conflict. They	include one-sided violent events in which the tool for engaging in conflict creates asymmetry by taking away the ability of the target to engage or defend themselves and their location (for example suicidal attacks or drone strikes). <b>CIVILIAN</b> refers to violent attacks on unarmed civilians.	</p>
                </div>
              <div class="legend_container" id="HDI_legend" style="display:none;">
                <h3>Human Development Index</h3> 
                <div class="legend" style="background:linear-gradient(to right, #ffffff, #ffffff 16%, #f9f9f9 16%, #f9f9f9 33%, #cbe9ce 33%, #cbe9ce 50%, #9cd8a5 50%, #9cd8a5 66%, #68c67c 66%, #68c67c 83%, #18b453 83%);"></div>
                <p class="legend_label" style="margin-left:40px;">0</p>
                <p class="legend_label" style="margin-left:30px;">0.2</p>
                <p class="legend_label" style="margin-left:23px;">0.4</p>
                <p class="legend_label" style="margin-left:18px;">0.6</p>
                <p class="legend_label" style="margin-left:26px;">0.8</p>
                <h2 style="font-size:24px; margin-top:30px;">HDI</h2>
                <p style="margin-top:10px;">The Human Development Index is based on the concept that people are the real wealth of a nation. The originators of the HDI recognised that there are three essential components required for humans to develop to their maximum ability: health, education and income. There is general agreement that if any one of these elements is absent, individual achievement will be severely limited (<a href="https://journals.sagepub.com/doi/full/10.1177/1757913913491350" target="_blank">more</a>) </p>
                <!-- <p><img src="assets/img/hdi.png" style="width:100%"/></p> -->
                <p style="margin-top:10px;">Countries which score low on the Human Development Index are more likely to experience conflict giving rise to internal displacement and refugee movements. Wealthier countries accept the better educated for permanent settlement, while admitting less skilled manual workers and asylum seekers on a temporary basis. (<a href="https://refuge.journals.yorku.ca/index.php/refuge/article/view/26042" target="_blank">more</a>)</p>
              </div>
              <!-- <div class="legend_container" id="school_legend" style="display:none;">
                <h2>Avg. Years of School</h2> 
                <div class="legend" style="background:linear-gradient(to right, #ffffff, #ffffff 16%, #f9f9f9 16%, #f9f9f9 33%, #f9cec7 33%, #f9cec7 50%, #f8a298 50%, #f8a298 66%, #ee756b 66%, #ee756b 83%, #e04040 83%);"></div>
                <p class="legend_label" style="margin-left:40px;">0</p>
                <p class="legend_label" style="margin-left:32px;">6</p>
                <p class="legend_label" style="margin-left:36px;">8</p>
                <p class="legend_label" style="margin-left:28px;">10</p>
                <p class="legend_label" style="margin-left:26px;">12</p>
                <h2 style="font-size:24px; margin-top:30px;">Case Study</h2>
                <p style="margin-top:10px;">It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. </p>
                <img style="width:300px; margin-top:20px;" src="assets/img/country_example.png">
            </div> -->
            <div class="legend_container" id="pov_legend" style="display:none;">
                <h3>% Population </h3> 
                <div class="legend" style="background:linear-gradient(to right, #ffffff, #ffffff 16%, #feedde 16%, #feedde 33%, #fdbe85 33%, #fdbe85 50%, #fd8d3c 50%, #fd8d3c 66%, #e6550d 66%, #e6550d 83%, #a63603 83%);"></div>
                <p class="legend_label" style="margin-left:40px;">0</p>
                <p class="legend_label" style="margin-left:30px;">40</p>
                <p class="legend_label" style="margin-left:25px;">55</p>
                <p class="legend_label" style="margin-left:25px;">70</p>
                <p class="legend_label" style="margin-left:23px;">85</p>
                <h2 style="font-size:24px; margin-top:30px;">Poverty</h2>
                <p style="margin-top:10px;">This map shows the percentage of population whose income falls below the poverty line. Data is derived from the World Development Indicators of the World Bank (<a href="http://wdi.worldbank.org/table/1.2" target="_blank">link</a>) listing the percentage of population living with less than $ 5.50 a day.</p>
                <p style="margin-top:10px;">Poverty is not per se a cause of forced migration, but can contribute to worsen situations stressed by other factors. Numerous among thr poorest countries host great numbers of refugees. These nations already face severe structural barriers to sustainable development, and usually have the least resources to respond to the needs of people seeking refuge. </p><p style="margin-top:10px;">The presence of camp populations can create tense situations with locals, but sometimes it can bring positive economic benefits to nearby communities and to the host country at large (<a href="https://ideas.repec.org/a/eee/deveco/v130y2018icp66-83.html" target="_blank">more</a>).</p> </div>
          <div class="legend_container" id="env_legend" style="display:none;">
            <h3>% Population at Risk </h3> 
            <div class="legend" style="background:linear-gradient(to right, #ffffff, #ffffff 16%, #e8e3ce 16%, #e8e3ce 33%, #d6cea3 33%, #d6cea3 50%, #c2ba7a 50%, #c2ba7a 66%, #aea651 66%, #aea651 83%, #989222 83%);"></div>
            <p class="legend_label" style="margin-left:41px;">0</p>
            <p class="legend_label" style="margin-left:30px;">20</p>
            <p class="legend_label" style="margin-left:28px;">40</p>
            <p class="legend_label" style="margin-left:25px;">60</p>
            <p class="legend_label" style="margin-left:22px;">80</p>
            <h2 style="font-size:24px; margin-top:30px;">Environmental risks</h2>
                <p style="margin-top:10px;">This map shows the percentage of population at risk of droughts, floods and extreme temperatures. Data is derived from the World Development Indicators of the World Bank (<a href="http://wdi.worldbank.org/table/3.11" target="_blank">link</a>)</p>
                <p style="margin-top:10px;">Environmental refugees are not protected by the 1951 Convention, making it difficult to visualize them due to lack of data. Estimates of the number of environmental refugees in the world vary widely, as do definitions and typologies of such flows (<a href="https://www.unhcr.org/research/working/3ae6a0d00/environmental-refugees-myth-reality-richard-black.html" target="_blank">more</a>)</p>
                <p style="margin-top:10px;">Nevertheless, there is a strong inter-linkage between conflict and environmental condition. An example is the drought that hit Somalia in 2011, after two years of rainfall interruption, as it occurred in the context of the civil war that has been tearing the country apart since 1991 (<a href="http://labos.ulg.ac.be/hugo/wp-content/uploads/sites/38/2017/11/The-State-of-Environmental-Migration-2011-75-90.pdf" target="_blank">more</a>)</p>
                <!-- <img style="width:300px; margin-top:20px;" src="assets/img/country_example.png"> -->
          </div>

        </div>
    </div>
    <div id="projectionButtons">
      <button style="display:inline-block; height:64px;" onclick="toEquirectangular()"><img style="width:60px; height:60px;" src="assets/img/rect.png"></img></button>
      <button style="display:inline-block; height:64px;" onclick="toOrthographic()"><img style="width:60px; height:60px;" src="assets/img/ortho.png"></img></button>
    </div>
    <div class="col-md-9">
      <svg>
        <defs>
            <radialGradient cx="75%" cy="25%" id="ocean_fill">
              <stop offset="5%" stop-color="#ddf" />
              <stop offset="100%" stop-color="#9ab" />
            </radialGradient>
            <radialGradient cx="75%" cy="25%" id="globe_highlight">
              <stop offset="5%" stop-color="#fff" stop-opacity="0.6" />
              <stop offset="100%" stop-color="#808080" stop-opacity="0.2" />
            </radialGradient>
            <radialGradient cx="50%" cy="40%" id="globe_shading">
              <stop offset="50%" stop-color="#ffffff" stop-opacity="0" />
              <stop offset="100%" stop-color="#808080" stop-opacity="0.3" />
            </radialGradient>
            <radialGradient cx="50%" cy="50%" id="drop_shadow">
              <stop offset="20%" stop-color="#000" stop-opacity="0.5" />
              <stop offset="100%" stop-color="#000" stop-opacity="0" />
            </radialGradient>
          <filter id="glow">
              <feColorMatrix type="matrix"
                  values=
                  "0.8 0 0 0 0
                  0 0.9 0 0 0
                  0 0 1 0 0
                  0 0 0 1 0"/>
              <feGaussianBlur stdDeviation="5.5" result="coloredBlur"/>
              <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
              </feMerge>
          </filter>
        </defs>
      </svg>
     </div> 
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <!-- Use d3-fetch instead of d3-request in ES6 -->
  <script src="https://d3js.org/d3-request.v1.min.js"></script>
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src="js/perfect-scrollbar.js"></script>
  <script src="js/d3-marker-cluster.js"></script>
  <script src="https://unpkg.com/supercluster@4.1.1/dist/supercluster.min.js"></script>
  <script src="js/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
  <script>

  //d3.select(window).on("load", sizeChange);
  d3.select(window).on("resize", sizeChange);

    const config = {
      speed: 0.005,
      verticalTilt: -30,
      horizontalTilt: 0
    };

    const ps = new PerfectScrollbar('#text', {
      wheelSpeed: .2,
      wheelPropagation: true,
      minScrollbarLength: 20
    });

    var width = window.innerWidth,
      height = window.innerHeight,
      sensitivity = 0.25,
      offsetX = width / 1.5,
      offsetY = height / 2,
      maxElevation = 45,
      initRotation = [0, -10],
      scaleExtent = [1, 8],
      flyerAltitude = 80,
      countryTooltip = d3.select("body").append("div").attr("class", "countryTooltip"),
      countryById = {},
      demographicsById = {},
      schoolById = {},
      povertyById = {},
      environmentById = {},
      countries,
      countryCentroids = {},
      conflictById = {},
      currentPos = initRotation,
      proj = 0,
      clusters;

    var radius = width / 3;
    if (height < width) {
      radius = height /2.25;
    }

    
    var projection1 = d3
      .geoOrthographic()
      .scale(radius)
      .rotate(initRotation)
      .translate([offsetX, offsetY])
      .clipAngle(90);
    var projection2 = d3
      .geoEquirectangular()
      .scale(radius)
      .translate([offsetX, offsetY]);
    var skyProjection1 = d3
      .geoOrthographic()
      .scale(radius + flyerAltitude)
      .rotate(initRotation)
      .translate([offsetX, offsetY])
      .clipAngle(90);
    var skyProjection2 = d3
      .geoEquirectangular()
      .scale(radius + flyerAltitude)
      .translate([offsetX, offsetY])
      .clipAngle(90);
    var projection = projection1,
        skyProjection = skyProjection1;
    var path = d3
      .geoPath()
      .projection(projection)
      .pointRadius(1.5);
    var swoosh = d3.line()
      .x(function(d) {
        return d[0]
      })
      .y(function(d) {
        return d[1]
      })
      .curve(d3.curveBasis);
    var graticule = d3.geoGraticule();

    var svg = d3
      .select("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("transform-origin", offsetX + "px " + offsetY + "px")
      .call(
        d3
        .drag()
        .subject(function() {
          var r = projection.rotate();
          return {
            x: r[0] / sensitivity,
            y: -r[1] / sensitivity
          };
        })
        .on("drag", function(){
          if (proj == 0){
            dragged()
          }
          else{
            dragged1()
          }
        })
        
      )
      .call(
        d3
        .zoom()
        .scaleExtent(scaleExtent)
        .on("zoom", zoomed)
      )
      .on("dblclick.zoom", null);

    var labels;

    // Data and color scale
    var hdiColorScale = d3.scaleThreshold()
        .domain([0.2, 0.4, 0.55, 0.7, 0.85])
        .range(["#ffffff","#f9f9f9","#cbe9ce","#9cd8a5","#68c67c","#18b453"]);
    var schoolColorScale = d3.scaleThreshold()
        .domain([0.01,6, 8, 10, 12])
        .range(["#ffffff","#f9f9f9","#f9cec7","#f8a298","#ee756b","#e04040"]);
    var povColorScale = d3.scaleThreshold()
        .domain([0.01,40, 55, 70, 85])
        .range(["#ffffff","#feedde","#fdbe85","#fd8d3c","#e6550d","#a63603"]);
    var environmentColorScale = d3.scaleThreshold()
        .domain([0.01,2.5, 4, 5.5, 7])
        .range(["#ffffff","#e8e3ce","#d6cea3","#c2ba7a","#aea651","#989222"]);
    var conflict_color = d3.scaleOrdinal()
        .domain(["b", "vc","rv"])
        .range(["#993333", "#e68a00","#ffff00"]);
    
    d3.queue()
      .defer(d3.json, "https://raw.githubusercontent.com/d3/d3.github.com/master/world-50m.v1.json")
      .defer(d3.json, "assets/map_data/global/cities.json")
      .defer(d3.json, "assets/map_data/global/links.json")
      .defer(d3.csv, "assets/map_data/global/country_names.csv")
      .defer(d3.csv, "assets/map_data/global/demographics.csv")
      .defer(d3.json, "assets/map_data/global/case_studies.json")
      .defer(d3.json, "assets/map_data/global/conflict.json")
      .defer(d3.csv, "assets/map_data/global/conflict_table.csv")
      .await(ready);

    function ready(error, world, places, links, countryNames, demographics,markers,conflict, conTable) {

    var defs = svg.append("defs");

    var filter = svg.append("defs")
      .append("filter")
      .attr("id", "drop-shadow")
      .attr("height", "110%");
    filter.append("feGaussianBlur")
      .attr("in", "SourceAlpha")
      .attr("stdDeviation", 0.5)
      .attr("result", "blur");

    filter.append("feOffset")
      .attr("in", "blur")
      .attr("dx", 1)
      .attr("dy", 1)
      .attr("result", "offsetBlur");
    
      var feMerge = filter.append("feMerge");

    feMerge.append("feMergeNode")
        .attr("in", "offsetBlur")
    feMerge.append("feMergeNode")
        .attr("in", "SourceGraphic");
        
    var gradient = svg.append("svg:defs")
      .append("svg:linearGradient")
        .attr("id", "gradient")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "0%")
        .attr("y2", "100%")
        .attr("spreadMethod", "pad");

    gradient.append("svg:stop")
        .attr("offset", "0%")
        .attr("stop-color", "#0F3871")
        .attr("stop-opacity", 1);

    gradient.append("svg:stop")
        .attr("offset", "100%")
        .attr("stop-color", "#175BA8")
        .attr("stop-opacity", 1);

      countries = topojson.feature(world, world.objects.countries).features;

      countryNames.forEach(function(d) {
        countryById[d.iso_n3] = d.name;
      });

      conTable.forEach(function(d) {
        conflictById[d.iso_n3] = d;
      });

      demographics.forEach(function(d) {
        demographicsById[d.id] = d.HDI;
        schoolById[d.id] = d.Years_school;
        povertyById[d.id] = d.Pop_below_550_day;
        environmentById[d.id] = d.environ;
      });
      
      svg
        .append("rect")
        .attr("width", width)
        .attr("height", height)
        .attr("transform-origin", offsetX + "px " + offsetY + "px")
        .attr("class", "noclicks")
        .style("fill", "#e3e4e8")
        .style("fill-opacity", 0);

      svg
        .append("ellipse")
        .attr("cx", offsetX - 40)
        .attr("cy", offsetY + radius - 20)
        .attr("rx", projection.scale() * 0.9)
        .attr("ry", projection.scale() * 0.25)
        .attr("class", "noclicks")
        .style("fill", "url(#drop_shadow)");
      svg
        .append("circle")
        .attr("cx", offsetX)
        .attr("cy", offsetY)
        .attr("r", projection.scale())
        .attr("class", "noclicks")
        .style("fill", "#ffffff");
      svg
        .append("path")
        .datum(topojson.feature(world, world.objects.land))
        .attr("class", "land")
        .attr("d", path)
        .style("filter", "url(#drop-shadow)");
      svg
        .append("path")
        .datum(graticule)
        .attr("class", "graticule noclicks")
        .attr("d", path);
      svg
        .append("circle")
        .attr("cx", offsetX)
        .attr("cy", offsetY)
        .attr("r", projection.scale())
        .attr("class", "noclicks")
        .style("fill", "url(#globe_highlight)");
      svg
        .append("circle")
        .attr("cx", offsetX)
        .attr("cy", offsetY)
        .attr("r", projection.scale())
        .attr("class", "noclicks")
        .style("fill", "url(#globe_shading)");
      svg
        .append("g")
        .attr("class", "countries")
        .selectAll("path")
        .data(countries)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "country")
        .attr("fill", function (d) {
            return '#c8cad0';
        })
        .attr("stroke", function (d) {
            return '#ffffff';
        })
        .on("mouseover", function(d) {
          countryTooltip.html(countryById[d.id] + '<br/>' + conflictById[d.id].TOTAL + ' Events<br/><canvas id="conflictTable"></canvas>')
          .style("left", (d3.event.pageX ) + "px")
          .style("top", (d3.event.pageY) + "px")
          .style("display", "block")
          .style("opacity", 1);

          var ctx = document.getElementById("conflictTable").getContext('2d');
              chart = new Chart(ctx, options);

              chart.data.datasets[0].data[0] = conflictById[d.id].BATTLES;
              chart.data.datasets[0].data[1] = conflictById[d.id].REMOTE;
              chart.data.datasets[0].data[2] = conflictById[d.id].CIVILIAN;
              chart.update();
        })
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0)
          .style("display", "none");
        });
      svg
        .append("g")
        .attr("class", "points")
        .selectAll(".point")
        .data(places.features)
        .enter()
        .append("path")
        .attr("class", "point")
        .attr("opacity", "point")
        .attr("d", path);
      svg
        .append("g")
        .attr("class", "labels")
        .selectAll(".map-label")
        .data(places.features)
        .enter()
        .append("text")
        .attr("id", "city-label")
        .attr("class", "map-label")
        .text(function(d) {
          return d.properties.NAME;
        });
      svg
        .append("g")
        .attr("class", "case-study points")
        .selectAll(".point")
        .data(markers.features)
        .enter()
        .append("path")
        .attr("class", "point-study")
        .attr("opacity", 1)
        .attr("d", path.pointRadius(6));
      svg
        .append("g")
        .attr("class", "labels")
        .selectAll(".map-label")
        .data(markers.features)
        .enter()
        .append("text")
        .attr("class", "map-label")
        .attr("id", "case-label")
        .text(function(d) {
          return d.properties.text;
        });
      
      svg
        .append("g")
        .attr("class", "conflict points")
        .selectAll(".point")
        .data(conflict.features)
        .enter()
        .append("path")
        .attr("class", "conflict-point")
        .attr("fill", function(d){
            return conflict_color(d.properties.type);
        })
        .attr("stroke", function(d){
            return conflict_color(d.properties.type);
        })
        .attr("opacity", 1)
        .attr("d", path.pointRadius(1));
      
      position_labels();
    }

    var cluster_size = d3.scaleLinear()
        .domain([0,10000])
        .range([5,100]);

    function getClusters(points) {
            const allClusters = [];

            // Group points by state
            const byType = d3
                .nest()
                .key(d => d.properties.type)
                .entries(points);

            // Cluster each group individually
            byType.forEach(entry => {
                const index = supercluster({
                    radius: 150,
                    maxZoom: 10
                });
                index.load(entry.values);
                index.getClusters([-180, -90, 180, 90], 5).forEach(cluster => {
                    // Add x, y, r, and state properties to each cluster
                    const [x, y] = projection(cluster.geometry.coordinates);
                    cluster.properties.type = entry.key;
                    cluster.x = x;
                    cluster.y = y;
                    cluster.r = cluster_size(cluster.properties.point_count);
                    allClusters.push(cluster);
                });
            });

            return allClusters;
        }
      
    function updateClusters(points){
      const allClusters = [];

      // Group points by state
      const byType = d3
          .nest()
          .key(d => d.properties.type)
          .entries(points);

      // Cluster each group individually
      byType.forEach(entry => {
          const index = supercluster({
              radius: 150,
              maxZoom: 10
          });
          index.load(entry.values);
          index.getClusters([-180, -90, 180, 90], 5).forEach(cluster => {
              // Add x, y, r, and state properties to each cluster
              const [x, y] = projection(cluster.geometry.coordinates);
              cluster.properties.type = entry.key;
              cluster.x = x;
              cluster.y = y;
              cluster.r = cluster_size(cluster.properties.point_count);
              allClusters.push(cluster);
          });
      });

      return allClusters;
    }


    function toEquirectangular(){      
      svg.selectAll("path").transition()
      .attrTween("d", projectionTween(projection, projection2));

      path = d3
        .geoPath()
        .projection(projection2)
        .pointRadius(1.5);

      projection = projection2;
      skyProjection = skyProjection2;

      svg
          .selectAll("circle").style("fill-opacity", 0);
      svg
          .selectAll("ellipse").style("fill-opacity", 0);
      svg
          .selectAll("rect").style("fill-opacity", 1);

      //document.getElementById("infoPanel").style.background = "rgba(0,0,0,0.2)";

      proj = 1;
      sizeChange();
    }

    function toOrthographic(){      
      svg.selectAll("path").transition()
      .attrTween("d", projectionTween(projection, projection1));

      path = d3
        .geoPath()
        .projection(projection1)
        .pointRadius(1.5);

      projection = projection1;
      skyProjection = skyProjection1;

      svg
          .selectAll("circle").style("fill-opacity", 1);
      svg
          .selectAll("ellipse").style("fill-opacity", 1);
      svg
          .selectAll("rect").style("fill-opacity", 0);

      //document.getElementById("infoPanel").style.background = "rgba(255,255,255,0.3)";

      proj = 0;
      sizeChange();
    }

    function projectionTween(projection0, projection1) {
    }

    function enableRotation() {
      d3.timer(function(elapsed) {
        projection.rotate([config.speed * elapsed - 120, config.verticalTilt, config.horizontalTilt]);
        svg.selectAll("path").attr("d", path);
         position_labels();
      });
    }

    function position_labels() {
      var centerPos = projection.invert([offsetX, offsetY]);
      svg
        .selectAll(".map-label")
        .attr("text-anchor", function(d) {
          var x = projection(d.geometry.coordinates)[0];
          return x < offsetX - 20 ? "end" : x < offsetX + 20 ? "middle" : "start";
        })
        .attr("transform", function(d) {
          var loc = projection(d.geometry.coordinates),
            x = loc[0],
            y = loc[1];
          var offset = x < offsetX ? -5 : 5;
          return "translate(" + (x + offset) + "," + (y - 2) + ")";
        })
        .style("display", function(d) {
          if (proj == 0){
            var d = d3.geoDistance(d.geometry.coordinates, centerPos);
            return d > 1.57 ? "none" : "inline";
            }
          else{
            return "inline";
          }
        });
      svg
        .selectAll("#case-label")
        .attr("transform", function(d) {
          var loc = projection(d.geometry.coordinates),
            x = loc[0],
            y = loc[1];
          var offset = x < offsetX ? -5 : 5;
          return "translate(" + (x + offset) + "," + (y - 8) + ")";
        })
    }

    function flying_arc(pts) {
      var source = pts.geometry.coordinates[0],
        target = pts.geometry.coordinates[1];
      var mid1 = location_along_arc(source, target, .333);
      var mid2 = location_along_arc(source, target, .667);
      var result = [projection(source),
        skyProjection(mid1),
        skyProjection(mid2),
        projection(target)
      ]
      // console.log(result);
      return result;
    }

    function fade_at_edge(d) {
      var centerPos = projection.invert([offsetX, offsetY]);
      start = d.geometry.coordinates[0];
      end = d.geometry.coordinates[1];
      var start_dist = 1.57 - d3.geoDistance(start, centerPos),
        end_dist = 1.57 - d3.geoDistance(end, centerPos);
      var fade = d3.scaleLinear().domain([-.1, 0]).range([0, .1])
      var dist = start_dist < end_dist ? start_dist : end_dist;
      return fade(dist)
    }

    function location_along_arc(start, end, loc) {
      var interpolator = d3.geoInterpolate(start, end);
      return interpolator(loc)
    }

    function dragged() {
      var o1 = [d3.event.x * sensitivity, -d3.event.y * sensitivity];
      o1[1] =
        o1[1] > maxElevation ?
        maxElevation :
        o1[1] < -maxElevation ?
        -maxElevation :
        o1[1];
      projection.rotate(o1);
      skyProjection.rotate(o1);
      refresh();
    }
    function dragged1() {
      var o1 = [d3.event.x * sensitivity];
      o1[1] =
        o1[1] > maxElevation ?
        maxElevation :
        o1[1] < -maxElevation ?
        -maxElevation :
        o1[1];
      projection.rotate(o1);
      skyProjection.rotate(o1);
      refresh();
    }
    function zoomed() {
      if (d3.event) {
        svg.attr("transform", "scale(" + d3.event.transform.k + ")");
      }
    }

    function refresh() {
      svg.selectAll(".land").attr("d", path);
      svg.selectAll(".countries path").attr("d", path);
      svg.selectAll(".graticule").attr("d", path);
      refreshLandmarks();
      refreshFlyers();
    }

    function refreshLandmarks(){
      svg.selectAll(".point-study").attr("d", path.pointRadius(6));
      svg.selectAll(".conflict-point").attr("d", path.pointRadius(1));
      svg.selectAll(".point").attr("d", path.pointRadius(1.5));
      /*svg.selectAll(".clusterHolder").attr("transform", function(d){ 
        var x = d.x + (d3.event.x * sensitivity);
        var y = d.y;
        return "translate(" + x + " " + y + ")";
      });*/
      svg.selectAll(".cluster").attr("d", path);
      position_labels();
    }

    function refreshFlyers() {
      svg.selectAll(".arc").attr("d", path)
        .attr("opacity", function(d) {
          return fade_at_edge(d)
        });
      svg.selectAll(".flyer")
        .attr("d", function(d) {
          return swoosh(flying_arc(d))
        })
        .attr("opacity", function(d) {
          return fade_at_edge(d)
        });
    }

    function decodeHtml(html){
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    }

    var legends = document.getElementsByClassName("legend_container");

    function setHDI(){
      svg
        .selectAll(".country")
        .attr("fill", function (d) {
          return hdiColorScale(parseFloat(demographicsById[d.id]));
        })
        .attr("stroke", function (d) {
            return 'rgba(15, 112, 52, .3)';
        })
        .on("mouseover", function(d) {
          countryTooltip.text(countryById[d.id] + ':\n' + demographicsById[d.id])
          .style("left", (d3.event.pageX ) + "px")
          .style("top", (d3.event.pageY) + "px")
          .style("display", "block")
          .style("opacity", 1);
        })
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0)
          .style("display", "none");
        });

        svg
          .selectAll(".conflict-point")
          .attr("opacity", 0);

        for (var i = 0; i < legends.length; i++) {
          legends[i].style.display = 'none';
        }
        document.getElementById("HDI_legend").style.display = "block";
    }
    function setSchool(){
      svg
        .selectAll(".country")
        .attr("fill", function (d) {
            return schoolColorScale(parseFloat(schoolById[d.id]));
        })
        .attr("stroke", function (d) {
            return 'rgba(154, 25, 25, .3)';
        })
        .on("mouseover", function(d) {
          countryTooltip.text(countryById[d.id] + ':\n' + schoolById[d.id])
          .style("left", (d3.event.pageX ) + "px")
          .style("top", (d3.event.pageY) + "px")
          .style("display", "block")
          .style("opacity", 1);
        })
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0)
          .style("display", "none");
        });
        for (var i = 0; i < legends.length; i++) {
          legends[i].style.display = 'none';
        }

        svg
          .selectAll(".conflict-point")
          .attr("opacity", 0);

        document.getElementById("school_legend").style.display = "block";
    }
    function setPoverty(){
      svg
        .selectAll(".country")
        .attr("fill", function (d) {
            return povColorScale(parseFloat(povertyById[d.id]));
        })
        .attr("stroke", function (d) {
            return 'rgba(74, 25, 2, .3)';
        })
        .on("mouseover", function(d) {
          countryTooltip.text(countryById[d.id] + ':\n' + povertyById[d.id])
          .style("left", (d3.event.pageX ) + "px")
          .style("top", (d3.event.pageY) + "px")
          .style("display", "block")
          .style("opacity", 1);
        })
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0)
          .style("display", "none");
        });

        svg
          .selectAll(".conflict-point")
          .attr("opacity", 0);

        for (var i = 0; i < legends.length; i++) {
          legends[i].style.display = 'none';
        }
        document.getElementById("pov_legend").style.display = "block";
    }
    function setEnvironment(){
      svg
        .selectAll(".country")
        .attr("fill", function (d) {
            return environmentColorScale(parseFloat(environmentById[d.id]));
        })
        .attr("stroke", function (d) {
            return 'rgba(104, 100, 24, .3)';
        })
        .on("mouseover", function(d) {
          countryTooltip.text(countryById[d.id] + ':\n' + environmentById[d.id])
          .style("left", (d3.event.pageX ) + "px")
          .style("top", (d3.event.pageY) + "px")
          .style("display", "block")
          .style("opacity", 1);
        })
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0)
          .style("display", "none");
        });

        svg
          .selectAll(".conflict-point")
          .attr("opacity", 0);

        for (var i = 0; i < legends.length; i++) {
          legends[i].style.display = 'none';
        }
        document.getElementById("env_legend").style.display = "block";
    }


    var options = {
          type: 'pie',
          data: {
              labels: ['Battles', 'Remote','Civilian'],
              datasets: [{
              backgroundColor: ['#993333','#ffff00','#e68a00'],
                  borderColor: '#ffffff',
                  data: [50,50,50]
              }]
          },
          options: {
              legend: {
                display:true,
                position:'left',
                labels:{
                  fontFamily:"'Roboto Condensed','sans-serif'",
									fontColor:'#ffffff',
									fontSize:16
                }
              },
              responsive: true,
              plugins: {
                labels: {
                  fontFamily:"'Roboto Condensed','sans-serif'",
                  fontSize: 12,
                  fontColor:'#000000',
                  showZero: false,
                  overlap: false
                }
              }
          }
        }

    function setConflict(){
      svg
        .selectAll(".country")
        .attr("fill", function (d) {
            return '#c8cad0';
        })
        .attr("stroke", function (d) {
            return '#ffffff';
        })
        .on("mouseover", function(d) {
          countryTooltip.html(countryById[d.id] + '<br/>' + conflictById[d.id].TOTAL + ' Events<br/><canvas id="conflictTable"></canvas>')
          .style("left", (d3.event.pageX ) + "px")
          .style("top", (d3.event.pageY) + "px")
          .style("display", "block")
          .style("opacity", 1);

          var ctx = document.getElementById("conflictTable").getContext('2d');
              chart = new Chart(ctx, options);

              chart.data.datasets[0].data[0] = conflictById[d.id].BATTLES;
              chart.data.datasets[0].data[1] = conflictById[d.id].REMOTE;
              chart.data.datasets[0].data[2] = conflictById[d.id].CIVILIAN;
              chart.update();
        })
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0)
          .style("display", "none");
        });
      
      /*svg
        .selectAll(".clusterHolder")
          .attr("opacity", 1);*/

      svg
        .selectAll(".conflict-point")
          .attr("opacity", 1);

        for (var i = 0; i < legends.length; i++) {
          legends[i].style.display = 'none';
        }
        document.getElementById("con_legend").style.display = "block";
    }

    function sizeChange() {
      width = window.innerWidth,
      height = window.innerHeight,
      offsetX = width / 1.5,
      offsetY = height / 2;

      radius = width / 3;
      if (height < width) {
        radius = height /2.25;
      }

    if (proj == 0){
      projection = d3 
        .geoOrthographic()
        .scale(radius)
        .rotate(currentPos)
        .translate([offsetX, offsetY])
        .clipAngle(90);
    }
    else{
      projection = d3 
      .geoEquirectangular()
      .scale(radius)
      .translate([offsetX, offsetY]);
    }

      d3.selectAll("ellipse")
        .attr("cx", offsetX - 40)
        .attr("cy", offsetY + radius - 20)
        .attr("rx", projection.scale() * 0.9)
        .attr("ry", projection.scale() * 0.25);

      d3.selectAll("circle")
        .attr("cx", offsetX)
        .attr("cy", offsetY)
        .attr("r", projection.scale());

      d3.select("rect")
        .attr("width", width)
        .attr("height", height)
        .attr("transform-origin", offsetX + "px " + offsetY + "px");

      path = d3
        .geoPath()
        .projection(projection)
        .pointRadius(1.5);

      refresh();
    }

  </script>
</body>

</html>
